<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>BenTheElder.io - Migrating My Site To Kubernetes</title>
  <style type="text/css">code{white-space: pre;}</style>
  <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="stylesheet" type="text/css" href="/style.css?stamp=1514090175"/> <!-- favicon, all platforms --> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png" /> <link rel="/apple-touch-icon-precomposed" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png" /> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png" /> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png" /> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/images/icons/apple-touch-icon-60x60.png" /> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png" /> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png" /> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png" /> <link rel="icon" type="image/png" href="/images/icons/favicon-196x196.png" sizes="196x196" /> <link rel="icon" type="image/png" href="/images/icons/favicon-96x96.png" sizes="96x96" /> <link rel="icon" type="image/png" href="/images/icons/favicon-32x32.png" sizes="32x32" /> <link rel="icon" type="image/png" href="/images/icons/favicon-16x16.png" sizes="16x16" /> <link rel="icon" type="image/png" href="/images/icons/favicon-128.png" sizes="128x128" /> <meta name="application-name" content="&nbsp;"/> <meta name="msapplication-TileColor" content="#FFFFFF" /> <meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png" /> <meta name="msapplication-square70x70logo" content="/images/icons/mstile-70x70.png" /> <meta name="msapplication-square150x150logo" content="/images/icons/mstile-150x150.png" /> <meta name="msapplication-wide310x150logo" content="/images/icons/mstile-310x150.png" /> <meta name="msapplication-square310x310logo" content="/images/icons/mstile-310x310.png" />
</head>
<body>
<!DOCTYPE html><html lang="en"><body><div><link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto:400,700" rel="stylesheet" lazyload="1" /></div><div class="header"><div class="header-content"><span class="brand"><a href="/">BenTheElder</a></span><div class="nav"><span><a href="/projects">PROJECTS</a> </span></span><span><a class="current" href="/posts">POSTS</a></span><span><a href="/about">ABOUT</a></div></div></div><div class="tile blog-content"><p class="title">Migrating My Site To Kubernetes - November 16th, 2017</p><p class="big bold padded centered-text warning">Disclaimer:  I work at Google in Cloud on Kubernetes things, but this is a personal post.</p><p><a href="https://bentheelder.io/blog/hello-again">Previously</a> when I brought my my site back online I breifly mentioned the simple setup I threw together with Caddy running on a tiny <a href="https://cloud.google.com/compute/">GCE</a> VM with a few scripts  —  Since then I've had plenty of time to experience the awesomeness that is managing services with <a href="https://kubernetes.io/">Kubernetes</a> at work while developing Kubernetes's <a href="https://github.com/kubernetes/test-infra/">testing infrastructure</a> (which we run on <a href="https://cloud.google.com/kubernetes-engine/">GKE</a>).</p><p>So I decided, of course, that it was only natural to migrate my own service(s) to Kubernetes for maximum dog-fooding. <img src="/images/kubernetes_logo.svg" class="emoji" title="kubernetes logo"></img>↔<img src="/images/emoji/emoji_u1f436.png" class="emoji" alt="dog" title="dog"></img></p><p>This turned out to be even easier than expected and I was quickly up and running on a toy single-node cluster running on a spare linux box at home with the help of the excellent <a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">official docs for setting up a cluster with kubeadm</a>. After that I set up <a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a> to handle ingress to my service(s) and <a href="https://github.com/jetstack/kube-lego">kube-lego</a> to manage <a href="https://letsencrypt.org/">letsencrypt</a> certificates. I then replaced Caddy with my own minimal containerized Go service to continue having <a href="https://developer.github.com/webhooks/">GitHub webhooks</a> trigger site updates. <img src="/images/gopher_favicon.svg" class="emoji" title="go gopher"></img></p><p>I did run into the following hiccups:</p><ol style="list-style-type: decimal"><li><p>To get DNS resolution within the cluster of external services I needed to <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/">configure kube-dns</a> with <code>kubectl apply -f ./k8s/kube-dns-configmap.yaml</code> where my <code>./k8s/kube-dns-configmap.yaml</code> contained:</p><div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co"># resolve external services using Google&#39;s public DNS</span>
<span class="fu">apiVersion:</span><span class="at"> v1</span>
<span class="fu">kind:</span><span class="at"> ConfigMap</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> kube-dns</span>
  <span class="fu">namespace:</span><span class="at"> kube-system</span>
<span class="fu">data:</span>
  <span class="fu">upstreamNameservers:</span><span class="at"> |</span>
<span class="kw">[</span>“8.8.8.8”<span class="kw">]</span></code></pre></div></li><li><p>I also needed to configure <a href="https://kubernetes.io/docs/admin/authorization/rbac/">RBAC</a> for <code>kube-lego</code> which doesn't currently ship with RBAC configured out of the box. Again, this was just involved applying a config update based on the comments at <a href="https://github.com/jetstack/kube-lego/issues/99">jetstack/kube-lego#99</a> with <code>kubectl apply -f k8s/kube-lego.yaml</code>. The config below is probably giving <code>kube-lego</code> a lot more access than it needs, but I wasn't particularly concerned about this since this is on a toy &quot;cluster&quot; for my personal site and the service is already managing my TLS certificates. <img src="/images/emoji/emoji_u1f937_1f3fb_200d_2642.png" alt="shrug" title="shrug" class="emoji"></img></p></li></ol><p>My <code>k8s/kube-lego.yaml</code> contained:</p><p><details></p><div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="co"># Complete setup for kube-lego.</span>
<span class="co"># The only thing specific to my cluster here is the lego.email setting,</span>
<span class="co"># the rest is just kube-lego with RBAC.</span>
<span class="co"># Thanks to comments at: https://github.com/jetstack/kube-lego/issues/99</span>
<span class="fu">apiVersion:</span><span class="at"> v1</span>
<span class="fu">kind:</span><span class="at"> Namespace</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> kube-lego</span>
<span class="ot">---</span>
<span class="fu">apiVersion:</span><span class="at"> v1</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> kube-lego</span>
  <span class="fu">namespace:</span><span class="at"> kube-lego</span>
<span class="fu">data:</span>
  <span class="co"># modify this to specify your address</span>
  <span class="fu">lego.email:</span><span class="at"> </span><span class="st">&quot;bentheelder@gmail.com&quot;</span>
  <span class="co"># configure for letsencrypt&#39;s production api</span>
  <span class="fu">lego.url:</span><span class="at"> </span><span class="st">&quot;https://acme-v01.api.letsencrypt.org/directory&quot;</span>
<span class="fu">kind:</span><span class="at"> ConfigMap</span>
<span class="ot">---</span>
<span class="fu">apiVersion:</span><span class="at"> rbac.authorization.k8s.io/v1beta1</span>
<span class="fu">kind:</span><span class="at"> ClusterRole</span>
<span class="fu">metadata:</span>
    <span class="fu">name:</span><span class="at"> lego</span>
<span class="fu">rules:</span>
<span class="kw">-</span> <span class="fu">apiGroups:</span>
  <span class="kw">-</span> <span class="st">&quot;&quot;</span>
  <span class="kw">-</span> <span class="st">&quot;extensions&quot;</span>
  <span class="fu">resources:</span>
  <span class="kw">-</span> configmaps
  <span class="kw">-</span> secrets
  <span class="kw">-</span> services
  <span class="kw">-</span> endpoints
  <span class="kw">-</span> ingresses
  <span class="kw">-</span> nodes
  <span class="kw">-</span> pods
  <span class="fu">verbs:</span>
  <span class="kw">-</span> list
  <span class="kw">-</span> get
  <span class="kw">-</span> watch
<span class="kw">-</span> <span class="fu">apiGroups:</span>
  <span class="kw">-</span> <span class="st">&quot;&quot;</span>
  <span class="fu">resources:</span>
  <span class="kw">-</span> services
  <span class="fu">verbs:</span>
  <span class="kw">-</span> create
<span class="kw">-</span> <span class="fu">apiGroups:</span>
  <span class="kw">-</span> <span class="st">&quot;extensions&quot;</span>
  <span class="kw">-</span> <span class="st">&quot;&quot;</span>
  <span class="fu">resources:</span>
  <span class="kw">-</span> ingresses
  <span class="kw">-</span> ingresses/status
  <span class="fu">verbs:</span>
  <span class="kw">-</span> get
  <span class="kw">-</span> update
  <span class="kw">-</span> create
  <span class="kw">-</span> list
  <span class="kw">-</span> patch
  <span class="kw">-</span> delete
  <span class="kw">-</span> watch
<span class="kw">-</span> <span class="fu">apiGroups:</span>
  <span class="kw">-</span> <span class="st">&quot;*&quot;</span>
  <span class="kw">-</span> <span class="st">&quot;&quot;</span>
  <span class="fu">resources:</span>
  <span class="kw">-</span> events
  <span class="kw">-</span> certificates
  <span class="kw">-</span> secrets
  <span class="fu">verbs:</span>
  <span class="kw">-</span> create
  <span class="kw">-</span> list
  <span class="kw">-</span> update
  <span class="kw">-</span> get
  <span class="kw">-</span> patch
  <span class="kw">-</span> watch
<span class="ot">---</span>
<span class="fu">apiVersion:</span><span class="at"> rbac.authorization.k8s.io/v1beta1</span>
<span class="fu">kind:</span><span class="at"> ClusterRoleBinding</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> lego</span>
<span class="fu">roleRef:</span>
  <span class="fu">apiGroup:</span><span class="at"> rbac.authorization.k8s.io</span>
  <span class="fu">kind:</span><span class="at"> ClusterRole</span>
  <span class="fu">name:</span><span class="at"> lego</span>
<span class="fu">subjects:</span>
  <span class="kw">-</span> <span class="fu">kind:</span><span class="at"> ServiceAccount</span>
    <span class="fu">name:</span><span class="at"> lego</span>
    <span class="fu">namespace:</span><span class="at"> kube-lego</span>
<span class="ot">---</span>
<span class="fu">apiVersion:</span><span class="at"> v1</span>
<span class="fu">kind:</span><span class="at"> ServiceAccount</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> lego</span>
  <span class="fu">namespace:</span><span class="at"> kube-lego</span>
<span class="ot">---</span>
<span class="fu">apiVersion:</span><span class="at"> extensions/v1beta1</span>
<span class="fu">kind:</span><span class="at"> Deployment</span>
<span class="fu">metadata:</span>
  <span class="fu">name:</span><span class="at"> kube-lego</span>
  <span class="fu">namespace:</span><span class="at"> kube-lego</span>
<span class="fu">spec:</span>
  <span class="fu">replicas:</span><span class="at"> 1</span>
  <span class="fu">template:</span>
    <span class="fu">metadata:</span>
      <span class="fu">labels:</span>
        <span class="fu">app:</span><span class="at"> kube-lego</span>
    <span class="fu">spec:</span>
      <span class="fu">serviceAccountName:</span><span class="at"> lego</span>
      <span class="fu">containers:</span>
      <span class="kw">-</span> <span class="fu">name:</span><span class="at"> kube-lego</span>
        <span class="fu">image:</span><span class="at"> jetstack/kube-lego:0.1.5</span>
        <span class="fu">imagePullPolicy:</span><span class="at"> Always</span>
        <span class="fu">ports:</span>
        <span class="kw">-</span> <span class="fu">containerPort:</span><span class="at"> 8080</span>
        <span class="fu">env:</span>
        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> LEGO_EMAIL</span>
          <span class="fu">valueFrom:</span>
            <span class="fu">configMapKeyRef:</span>
              <span class="fu">name:</span><span class="at"> kube-lego</span>
              <span class="fu">key:</span><span class="at"> lego.email</span>
        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> LEGO_URL</span>
          <span class="fu">valueFrom:</span>
            <span class="fu">configMapKeyRef:</span>
              <span class="fu">name:</span><span class="at"> kube-lego</span>
              <span class="fu">key:</span><span class="at"> lego.url</span>
        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> LEGO_NAMESPACE</span>
          <span class="fu">valueFrom:</span>
            <span class="fu">fieldRef:</span>
              <span class="fu">fieldPath:</span><span class="at"> metadata.namespace</span>
        <span class="kw">-</span> <span class="fu">name:</span><span class="at"> LEGO_POD_IP</span>
          <span class="fu">valueFrom:</span>
            <span class="fu">fieldRef:</span>
              <span class="fu">fieldPath:</span><span class="at"> status.podIP</span>
        <span class="fu">readinessProbe:</span>
          <span class="fu">httpGet:</span>
            <span class="fu">path:</span><span class="at"> /healthz</span>
            <span class="fu">port:</span><span class="at"> 8080</span>
          <span class="fu">initialDelaySeconds:</span><span class="at"> 5</span>
          <span class="fu">timeoutSeconds:</span><span class="at"> 1</span>
<span class="ot">---</span></code></pre></div><p></details></p><p>After applying these two changes the rest of <a href="https://github.com/BenTheElder/site/tree/master/k8s">my very simple config</a> to deploy the Go service behind automatic TLS termination worked flawlessly. Since then managing the site has been an excellent experience with the power of <code>kubectl</code>, <a href="https://kubernetes.io/docs/user-guide/kubectl-overview/">the kubernetes swiss army knife</a>.</p><p>In conclusion:</p><ul><li><p>If you haven't given Kubernetes a try but you are already comfortable with Docker you should give it a try. Kubernetes makes managing services <em>easy and portable</em>. The same <code>kubectl</code> commands I use to debug our services for the Kubernetes project's infrstructure on GKE work just as well on my toy cluster at home. <img src="/images/emoji/emoji_u1f604.png" alt="grin" title="grin" class="emoji"></img></p></li><li><p>If you want to give Kubernetes a try with much less effort <a href="https://cloud.google.com/">Google Cloud</a> offers <a href="https://cloud.google.com/free/">a free 12 month, $300 credit</a> and an <a href="https://cloud.google.com/free/">always-free tier</a> which both include <a href="https://cloud.google.com/kubernetes-engine/">Google Kubernetes Engine</a>.<br />
We use GKE heavily for the project infrastructure and I can speak highly to it's ease of use and freedom to focus on your services without worrying about setting up and maintaining all of the pluggable Kubernetes bits such as <a href="https://kubernetes.io/docs/tasks/debug-application-cluster/logging-stackdriver/">logging</a>, <a href="https://cloud.google.com/kubernetes-engine/docs/clusters/upgrade">master upgrades</a>, <a href="https://cloud.google.com/kubernetes-engine/docs/node-auto-repair">node auto repair</a>, <a href="https://cloud.google.com/iam/">IAM</a>, <a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/#google-compute-engine-gce">cluster networking</a>, etc.</p></li></ul><p>If my site were a serious production service instead of a toy learning experience I would seriously look towards GKE instead of a one node &quot;cluster&quot; running on a DIY &quot;server&quot; sitting by my desk at home, but setting up a toy cluster with <code>kubeadm</code> was a great experience for experimenting with Kubernetes. I can reccomend using kubeadm for similar experiments, it's quite simple to use once you have all the prerequesites installed and configured and the docs are quite good, however it won't solve many of the things you'll want for a production cluster.</p><p>You may also want to look around the list of the many <a href="https://www.cncf.io/certification/software-conformance/">CNCF certified Kubernetes conformant products</a> for other options if for some reason neither of these sound appealing to you.</p><hr /><p>Addendum:</p><ol style="list-style-type: decimal"><li>I also used <a href="https://www.projectcalico.org/">Calico</a> for my overlay network, but I haven't really exercised it yet so I can't really comment on it.</li><li>Kubernetes <a href="https://kubernetes.io/docs/concepts/configuration/secret/">secrets</a> are awesome. My simple Go service can just read in the GitHub webhook secret as an environment variable injected into the container without worrying about how the secret is loaded and stored. <img src="/images/emoji/emoji_u1f510.png" title="Locked with Key" class="emoji"></img></li><li>To get a one node cluster working you need to <a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#master-isolation">remove the master taint</a>. This is terrible idea for a production cluster but great for tinkering and effectively using kubelet as your PID1.</li></ol><div style="clear: both;"></div></div></div><!--comments tile--><div class="tile"><p class="title">Comments</p><div id="disqus_thread"></div><script>
    var disqus_config = function () {
        this.page.url = "https://bentheelder.io/blog/migrating-my-site-to-kubernetes";
        this.page.identifier = "blog/migrating-my-site-to-kubernetes";
    };
    (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://bentheelder.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script><noscript><p>Comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a> require <a href="http://www.enable-javascript.com/">JavaScript enabled</a> to view.</a></p></noscript></div></body></html>
</body>
</html>
